<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#d4af37">
<title>Fiestas QR — Cloud</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&family=Great+Vibes&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- Generar / Leer QR -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>

<script>
/* Fallback robusto QR */
(function ensureQRCodeLib(){
  if (window.qrLibReady) return;
  window.qrLibReady = (async () => {
    function loadedOK(){ return !!(window.QRCode && (QRCode.toCanvas || QRCode.CorrectLevel)); }
    if (loadedOK()) return true;
    const loadScript = (src)=>new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);});
    const cdns=[
      "https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"
    ];
    for (const url of cdns){ try{ await loadScript(url); if (loadedOK()) return true; }catch{} }
    return false;
  })();
})();
</script>

<style>
:root{--bg:#F5F4F0;--panel:#FAF9F6;--card:#FFFFFF;--text:#1f2937;--muted:#6B7280;--gold:#d4af37;--ok:#22c55e;--danger:#ef4444;--radius:16px;--shadow:0 8px 16px rgba(0,0,0,.06),0 1px 4px rgba(0,0,0,.05);--border:1px solid rgba(0,0,0,.08)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:linear-gradient(180deg,var(--panel),var(--bg));color:var(--text);font-family:"Poppins",system-ui,Segoe UI,Roboto,sans-serif}
.container{max-width:1120px;margin:0 auto;padding:16px}@media(min-width:860px){.container{padding:24px}}
header{position:sticky;top:0;background:rgba(250,249,246,.85);backdrop-filter:blur(8px);border-bottom:var(--border);z-index:20}
header .container{display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;gap:12px;align-items:center;font-weight:900}
.brand .mark{width:32px;height:32px;border-radius:50%;background:radial-gradient(circle at 30% 30%,var(--gold),#b18a1a);box-shadow:0 0 0 3px rgba(212,175,55,.25)}@media(min-width:860px){.brand .mark{width:36px;height:36px}}
.btn{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;background:#f1f5f9;color:#111827;box-shadow:inset 0 0 0 1px rgba(0,0,0,.08);letter-spacing:.2px;transition:transform .06s ease,box-shadow .12s ease,background .12s ease}
.btn:focus{outline:2px solid rgba(212,175,55,.45);outline-offset:2px}.btn:active{transform:translateY(1px) scale(.99)}
.btn.gold{background:linear-gradient(180deg,#f8e38c,#d4af37);color:#2a1f0b;box-shadow:0 4px 12px rgba(212,175,55,.25)}
.btn.ghost{background:#fff;border:1px solid rgba(0,0,0,.08)}
.btn.ok{background:linear-gradient(180deg,rgba(34,197,94,.2),rgba(34,197,94,.35));border:1px solid rgba(34,197,94,.45);color:#064e3b}
.btn.danger{background:linear-gradient(180deg,rgba(239,68,68,.95),rgba(185,28,28,.98));color:#fff;box-shadow:0 4px 12px rgba(239,68,68,.25)}
.grid{display:grid;gap:16px}.grid.two{grid-template-columns:1fr}@media(min-width:860px){.grid.two{grid-template-columns:1fr 1fr}}
.card{background:var(--card);border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.card .card-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:var(--border)}
.card .card-c{padding:14px 16px}@media(min-width:860px){.card .card-h{padding:16px 18px}.card .card-c{padding:16px 18px}}
.field{display:grid;gap:6px}label{font-size:.9rem;color:var(--muted)}
input,select{background:#fff;border:1px solid rgba(0,0,0,.12);color:#1f2937;border-radius:12px;padding:12px;width:100%}
input::placeholder{color:#9aa3af}.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.hidden{display:none!important}.muted{color:var(--muted)}.mini{font-size:.9rem}
.tabs{display:flex;gap:8px;flex-wrap:wrap}.tab{padding:10px 14px;border-radius:999px;border:1px solid rgba(0,0,0,.12);cursor:pointer;font-weight:700;background:#fff}
.tab.active{background:linear-gradient(180deg,#f8e38c,#d4af37);color:#2a1f0b;border-color:#d4af37}
.pill{padding:6px 10px;border-radius:999px;font-size:.8rem;border:1px solid rgba(0,0,0,.12);background:#fff}
.pill.ok{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35);color:#065f46}
.list{display:grid;gap:12px}.event-card{display:grid;gap:12px;padding:16px;border-radius:16px;border:var(--border);background:#fff}
table{border-collapse:collapse;width:100%;min-width:720px}th,td{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08);text-align:left;vertical-align:middle}thead th{background:#fafafa;font-size:.9rem;color:#4b5563}
.qr-box{display:grid;place-items:center;padding:12px;border-radius:16px;background:#fafafa;border:1px dashed rgba(212,175,55,.5)}
.scroll-area{max-height:420px;overflow:auto;padding-right:6px}
.scroll-area::-webkit-scrollbar{width:10px}.scroll-area::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:10px}
.logo-row{display:flex;gap:8px;align-items:center}.logo-prev{width:140px;height:70px;border:1px dashed rgba(0,0,0,.2);border-radius:12px;object-fit:contain;background:#fff}
.logo-editor{display:none;border-top:1px solid rgba(0,0,0,.08);padding-top:10px;margin-top:10px}.logo-editor.active{display:block}
.logo-grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}.logo-grid .field{min-width:0}
.font-editor{display:none;border-top:1px solid rgba(0,0,0,.08);padding-top:10px;margin-top:10px}.font-editor.active{display:block}
.font-grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}.font-grid .field{min-width:0}
.video{width:100%;max-height:360px;border-radius:16px;border:1px solid rgba(0,0,0,.12);background:#000}
.scan-wrap{position:relative}.scan-overlay{pointer-events:none;position:absolute;inset:0;display:grid;place-items:center}
.scan-frame{width:min(70%,520px);height:min(70vw,320px);border:3px solid rgba(255,255,255,.95);border-radius:14px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:200}
.modal-body{background:#fff;border:var(--border);border-radius:18px;box-shadow:var(--shadow);padding:12px;max-width:780px;width:100%}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:var(--border)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#f9fafb;border:1px solid rgba(0,0,0,.2);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:100}
.fab{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;border-radius:999px;padding:12px 16px;box-shadow:var(--shadow);cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="brand"><div class="mark"></div><span>Fiestas<span style="color:var(--gold)">QR</span></span></div>
    <div class="row" id="userBar" style="align-items:center">
      <span id="userEmail" class="mini"></span>
      <button class="btn ghost" id="logoutBtn" title="Cerrar sesión">Salir</button>
    </div>
  </div>
</header>

<section id="needFirebase" class="container hidden" aria-live="polite">
  <div class="card">
    <div class="card-h"><strong>Configuración requerida</strong></div>
    <div class="card-c">
      <p>Completá <code>firebaseConfig</code> con tu proyecto y activá Auth (Email/Password). Agregá el dominio en <em>Authorized domains</em>.</p>
    </div>
  </div>
</section>

<main class="container">
  <!-- AUTENTICACIÓN -->
  <section id="auth" class="hidden">
    <div class="grid two">
      <div class="card">
        <div class="card-h"><strong>Iniciar sesión</strong></div>
        <div class="card-c">
          <form id="loginForm" class="grid" novalidate>
            <div class="field"><label for="loginEmail">Correo</label><input id="loginEmail" type="email" placeholder="empresa@ejemplo.com" autocomplete="username email" required /></div>
            <div class="field"><label for="loginPass">Contraseña</label><input id="loginPass" type="password" placeholder="********" autocomplete="current-password" required minlength="6" /></div>
            <div class="row"><button class="btn gold" id="loginBtn" type="submit">Entrar</button></div>
            <div class="mini muted" id="authHintLogin"></div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-h"><strong>Registración</strong></div>
        <div class="card-c">
          <form id="regForm" class="grid" novalidate>
            <div class="field"><label for="regEmail">Correo</label><input id="regEmail" type="email" placeholder="empresa@ejemplo.com" autocomplete="email" required /></div>
            <div class="field"><label for="regPass">Contraseña</label><input id="regPass" type="password" placeholder="Crea una contraseña (6+)" autocomplete="new-password" required minlength="6" /></div>
            <div class="row"><button class="btn ok" id="registerBtn" type="submit">Crear cuenta</button></div>
            <div class="mini muted" id="authHintReg"></div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="hidden">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:14px">
      <!-- ORDEN SOLICITADO -->
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="eventos">Eventos</div>
        <div class="tab" data-tab="invitados">Invitados</div>
        <div class="tab" data-tab="caducadas">Invitaciones caducadas</div>
        <div class="tab" data-tab="escanear">Escanear QR</div>
      </div>
      <span class="badge" id="modeBadge">cloud</span>
    </div>

    <!-- IDENTIDAD (sólo aparece en pestaña Invitados) -->
    <div id="identidadTop" class="card" style="margin-bottom:16px">
      <div class="card-h">
        <strong>Identidad (logo global)</strong>
        <span class="mini muted">Se aplica a todos los flyers</span>
      </div>
      <div class="card-c">
        <div class="logo-row">
          <img id="logoPreviewTop" class="logo-prev" alt="Logo" />
          <input id="logoFileTop" type="file" accept="image/*" />
          <button class="btn ghost" id="clearLogoBtnTop" type="button">Quitar logo</button>
        </div>
      </div>
    </div>

    <!-- INVITADOS -->
    <div id="vista-invitados" class="hidden">
      <div class="grid two">
        <div class="card">
          <div class="card-h"><strong>Registrar nuevo invitado</strong></div>
          <div class="card-c">
            <div class="row" style="align-items:flex-end">
              <div class="field" style="flex:1 1 260px"><label for="invNombre">Nombre y apellido</label><input id="invNombre" placeholder="Ej: Ana Pérez" /></div>
              <div class="field" style="width:220px"><label for="invEvento">Evento</label><select id="invEvento"></select></div>
              <div class="field" style="width:200px"><label for="invTipo">Tipo</label><select id="invTipo"><option value="egresado">Egresado</option><option value="invitado">Invitado (acompañante)</option></select></div>
              <div class="field" id="wrapInvEgresado" style="width:260px;display:none"><label for="invEgresadoSel">Asignar a egresado</label><select id="invEgresadoSel"><option value="">Elegí egresado…</option></select></div>
              <div class="field" style="width:220px"><label>&nbsp;</label><button class="btn gold" id="registrarInvitadoBtn" type="button">Crear invitación + QR</button></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h"><strong>Invitados recientes</strong></div>
          <div class="card-c"><div id="listaInvitadosRecientes" class="scroll-area"></div></div>
        </div>
      </div>

      <!-- Edición/QR — ABAJO -->
      <div id="qrPreview" class="hidden card" style="margin-top:16px">
        <div class="card-h"><strong>Edición de invitación</strong></div>
        <div class="card-c">
          <div class="grid" style="grid-template-columns:1fr;gap:12px">
            <div class="card" style="border:1px dashed rgba(0,0,0,.06)">
              <div class="card-c">
                <div class="row" style="gap:18px">
                  <label class="mini">Tema flyer:
                    <select id="flyerThemeSel">
                      <option value="oro">Oro</option><option value="plata">Plata</option><option value="noche">Noche</option><option value="custom">Personalizado</option>
                    </select>
                  </label>
                  <div class="row color-pick"><span class="mini">Colores:</span>
                    <label class="mini">Fondo <input type="color" id="bgColorPick" value="#ffffff"></label>
                    <label class="mini">Texto <input type="color" id="txColorPick" value="#1f2937"></label>
                  </div>
                  <button class="btn ok" id="toggleFontEditorBtn" type="button">Editar tamaño de letra</button>
                </div>

                <div id="fontEditor" class="font-editor" style="margin-top:8px">
                  <div class="font-grid">
                    <div class="field"><label>Encabezado</label><input id="fontHead" type="range" min="20" max="80" step="1"><span class="mini muted" id="fontHeadVal"></span></div>
                    <div class="field"><label>Título del evento</label><input id="fontEvent" type="range" min="36" max="120" step="1"><span class="mini muted" id="fontEventVal"></span></div>
                    <div class="field"><label>Nombre</label><input id="fontGuest" type="range" min="24" max="80" step="1"><span class="mini muted" id="fontGuestVal"></span></div>
                    <div class="field"><label>Token</label><input id="fontToken" type="range" min="20" max="64" step="1"><span class="mini muted" id="fontTokenVal"></span></div>
                    <div class="field"><label>Nota</label><input id="fontNote" type="range" min="16" max="40" step="1"><span class="mini muted" id="fontNoteVal"></span></div>
                    <div class="field"><label>&nbsp;</label><div class="row"><button class="btn ghost" id="fontResetBtn">Reset texto</button></div></div>
                  </div>
                </div>

                <div class="logo-row" style="margin-top:6px">
                  <label class="mini">Logo en flyer:</label>
                  <img id="logoPreview" class="logo-prev" alt="Logo" />
                  <input id="logoFile" type="file" accept="image/*" />
                  <button class="btn ghost" id="clearLogoBtn" type="button">Quitar logo</button>
                  <button class="btn ok" id="toggleLogoEditorBtn" type="button">Editar logo</button>
                </div>

                <div id="logoEditor" class="logo-editor">
                  <div class="logo-grid">
                    <div class="field"><label>Tamaño</label><input id="logoScale" type="range" min="10" max="300" step="1"></div>
                    <div class="field"><label>Posición X</label><input id="logoX" type="range" min="0" max="1200" step="1"></div>
                    <div class="field"><label>Posición Y</label><input id="logoY" type="range" min="0" max="675" step="1"></div>
                    <div class="field"><label>&nbsp;</label><div class="row"><button class="btn ghost" id="logoResetBtn">Reset</button><button class="btn ok" id="logoToggleBtn">Mostrar/ocultar</button></div></div>
                  </div>
                </div>

                <div style="margin-top:8px">
                  <strong id="qrNombre"></strong>
                  <div class="mini">Evento: <span id="qrEvento"></span></div>
                  <div class="mini">Token: <span id="qrToken"></span></div>
                  <div class="mini">Uso único. Mostrar al recepcionista.</div>
                </div>
              </div>
            </div>

            <div class="qr-box"><div id="qrCanvas" data-guest-id=""></div></div>

            <div class="row" id="qrButtonsRow">
              <button class="btn ok" id="genFlyerBtn" type="button">Generar flyer</button>
              <button class="btn ok" id="descargarQRBtn" type="button">Descargar PNG (QR)</button>
              <button class="btn gold" id="descargarFlyerBtn" type="button">Descargar Flyer (PNG)</button>
              <button class="btn ghost" id="doneInviteBtn" type="button">Listo</button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /vista-invitados -->

    <!-- EVENTOS -->
    <div id="vista-eventos">
      <div class="grid two">
        <div class="card">
          <div class="card-h"><strong>Nuevo evento</strong></div>
          <div class="card-c">
            <div class="row">
              <div class="field" style="flex:1 1 240px"><label for="evNombre">Nombre del evento</label><input id="evNombre" placeholder="Ej: Fiesta Primavera" /></div>
              <div class="field" style="width:210px"><label for="evFecha">Fecha</label><input id="evFecha" type="date" /></div>
              <div class="field" style="width:210px"><label>&nbsp;</label><button class="btn gold" id="crearEventoBtn" type="button">Crear evento</button></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h"><strong>Buscar invitados por evento</strong></div>
          <div class="card-c">
            <div class="field"><label for="buscarEventoSel">Elegí un evento</label><select id="buscarEventoSel"></select></div>
            <div class="row" style="margin-top:10px;align-items:center">
              <input id="buscarInvitadosInput" placeholder="Buscar por nombre..." />
              <button class="btn ghost" id="buscarInvitadosBtn" type="button">Buscar</button>
            </div>
            <div id="zonaInvitadosEvento" style="margin-top:12px"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="card-h"><strong>Lista de eventos</strong></div>
        <div class="card-c"><div id="listaEventos" class="list"></div></div>
      </div>
    </div>

    <!-- CADUCADAS -->
    <div id="vista-caducadas" class="hidden">
      <div class="card">
        <div class="card-h"><strong>Invitaciones caducadas</strong></div>
        <div class="card-c">
          <div class="field"><label for="buscarCad">Buscar</label><input id="buscarCad" placeholder="Nombre o evento..." /></div>
          <div id="listaCaducadas" style="margin-top:12px"></div>
        </div>
      </div>
    </div>

    <!-- ESCANEAR -->
    <div id="vista-escanear" class="hidden">
      <div class="card">
        <div class="card-h"><strong>Escanear QR</strong></div>
        <div class="card-c">
          <div class="row" style="align-items:center">
            <div class="field" style="flex:1 1 260px"><label for="scanEvento">Limitar al evento (opcional)</label><select id="scanEvento"></select></div>
            <div class="field" style="width:210px"><label>&nbsp;</label><button class="btn gold" id="scanBtn" type="button">Iniciar cámara</button></div>
          </div>
          <div class="row" style="margin-top:8px;align-items:center">
            <span class="pill ok">Usá HTTPS o localhost</span>
            <div class="row" style="margin-left:auto;gap:8px;align-items:center">
              <label class="mini">Resolución
                <select id="resSel"><option value="auto">Auto</option><option value="hd">HD</option><option value="fhd">FullHD</option></select>
              </label>
              <button class="btn ghost" id="torchBtn" type="button">🔦 Linterna</button>
            </div>
          </div>
          <div class="scan-wrap" style="margin-top:8px">
            <video id="video" class="video" playsinline autoplay muted></video>
            <div id="scanOverlay" class="scan-overlay"><div class="scan-frame"></div></div>
          </div>
          <div class="help" id="cameraHint" style="margin-top:6px"></div>
          <div class="row" style="margin-top:12px;align-items:center">
            <div class="field" style="flex:1 1 260px"><label>Ingreso manual</label><input id="manualCode" placeholder="TOKEN (6) o URL ?u=&g=&t=" /></div>
            <div class="field" style="width:200px"><label>&nbsp;</label><button class="btn ok" id="validarManualBtn" type="button">Validar</button></div>
          </div>
          <div id="scanResultado" style="margin-top:12px" class="mini muted">Estado: esperando…</div>
        </div>
      </div>
    </div>

    <div class="foot">Hecho con <span style="color:var(--gold)">★</span> — Cloud only.</div>
  </section>
</main>

<div class="fab" id="fabScan">📷 Escanear</div>

<!-- Modal check-in -->
<div id="modalCheckin" class="modal" role="dialog" aria-modal="true" aria-label="Ingreso confirmado">
  <div class="modal-body">
    <div class="modal-head">
      <strong>Ingreso confirmado</strong>
      <button class="btn ghost" id="modalCloseBtn" type="button">Cerrar</button>
    </div>
    <div style="padding:12px">
      <img id="checkinFlyerImg" style="width:100%;max-width:720px;border-radius:16px;border:1px solid rgba(0,0,0,.12)" alt="Check-in Flyer">
    </div>
  </div>
</div>

<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBoQwu1L04BRGVFgUlbebSEjwMFL87lSQE",
  authDomain: "ok-invitaciones.firebaseapp.com",
  projectId: "ok-invitaciones",
  storageBucket: "ok-invitaciones.firebasestorage.app",
  messagingSenderId: "552768626682",
  appId: "1:552768626682:web:6b0b9b275e746f8fb00e43",
  measurementId: "G-Q2DT9HK5PN"
};

/* ===== Estado ===== */
const state = {
  user:null, uid:null,
  events:[], guests:[],
  ui:{
    currentTab:'eventos',     // ← pestaña inicial alineada con el orden solicitado
    invitadosEventoActual:null,
    flyerTheme:'oro',
    lastGuestId:null,
    bgColor:'#ffffff', txColor:'#1f2937',
    logoDataUrl: localStorage.getItem('fq_logo') || null,
    logo: JSON.parse(localStorage.getItem('fq_logo_cfg')||'{"x":60,"y":560,"scale":160,"visible":true}'),
    fonts: JSON.parse(localStorage.getItem('fq_font_cfg') || JSON.stringify({head:46,event:72,guest:40,token:34,note:26}))
  },
  flyers:{ lastDataUrl:null }
};
let db=null, auth=null;
const mustHaveFirebase = !!(firebaseConfig && firebaseConfig.apiKey);

/* ===== Utils ===== */
const $ = (id)=>document.getElementById(id);
function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2200);}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
function newToken(){let t;do{t=(Math.floor(Math.random()*900000)+100000).toString();}while(state.guests.some(g=>g.token===t));return t;}
async function sha256hex(str){
  try{ if (window.isSecureContext && crypto?.subtle){ const enc=new TextEncoder(); const buf=await crypto.subtle.digest('SHA-256', enc.encode(str)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); } }
  catch(_){} let h=0; for (let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return ('00000000'+(h>>>0).toString(16)).slice(-8);
}
function emailValido(e){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim());}

/* ===== Firestore refs ===== */
const colEvents=()=>db.collection('users').doc(state.uid).collection('events');
const colGuests=()=>db.collection('users').doc(state.uid).collection('guests');
const colPublic=()=>db.collection('public_guests');

/* ===== Init Cloud ===== */
async function initCloud(){
  if(!mustHaveFirebase){ $('needFirebase').classList.remove('hidden'); $('auth').classList.add('hidden'); $('app').classList.add('hidden'); return; }
  if(!firebase?.apps?.length) firebase.initializeApp(firebaseConfig);
  auth=firebase.auth(); db=firebase.firestore();
  try{ await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);}catch{}
  auth.onAuthStateChanged(async(user)=>{ state.user=user||null; state.uid=user?user.uid:null; syncUIAuth(); if(user){await cloudSubscribe();} });
  $('auth').classList.remove('hidden');
  $('loginForm')?.addEventListener('submit',onLoginSubmit);
  $('regForm')?.addEventListener('submit',onRegisterSubmit);
}

/* ===== Registro / Login ===== */
function setBusy(btn,isBusy,labelBusy,orig){btn.disabled=!!isBusy; btn.textContent=isBusy?labelBusy:orig;}
function presentAuthError(where, err){
  const map={'auth/email-already-in-use':'Ese correo ya está registrado.','auth/invalid-email':'Correo inválido.','auth/weak-password':'La contraseña debe tener 6+ caracteres.','auth/user-not-found':'No existe una cuenta con ese correo.','auth/wrong-password':'Contraseña incorrecta.','auth/network-request-failed':'Sin conexión o bloqueado por red.','auth/operation-not-allowed':'Habilitá "Email/Password" en Firebase Authentication.','auth/domain-not-allowed':'Dominio no autorizado.'};
  const msg = map[err?.code] || 'No se pudo completar la operación.'; const el=$(where); if(el){el.textContent=msg; el.style.color='#b91c1c';} toast(msg);
}
async function onRegisterSubmit(e){e.preventDefault();const email=($('regEmail').value||'').trim().toLowerCase();const pass=$('regPass').value||'';const btn=$('registerBtn');$('authHintReg').textContent='';if(!emailValido(email))return presentAuthError('authHintReg',{code:'auth/invalid-email'});if(pass.length<6)return presentAuthError('authHintReg',{code:'auth/weak-password'});const orig=btn.textContent;setBusy(btn,true,'Creando…',orig);try{await auth.createUserWithEmailAndPassword(email,pass);$('authHintReg').style.color='#065f46';$('authHintReg').textContent='Cuenta creada ✔️';toast('Cuenta creada ✔️');}catch(err){presentAuthError('authHintReg',err);}finally{setBusy(btn,false,'',orig);}}
async function onLoginSubmit(e){e.preventDefault();const email=($('loginEmail').value||'').trim().toLowerCase();const pass=$('loginPass').value||'';const btn=$('loginBtn');$('authHintLogin').textContent='';if(!emailValido(email))return presentAuthError('authHintLogin',{code:'auth/invalid-email'});const orig=btn.textContent;setBusy(btn,true,'Ingresando…',orig);try{await auth.signInWithEmailAndPassword(email,pass);$('authHintLogin').style.color='#065f46';$('authHintLogin').textContent='Bienvenido 👋';toast('Bienvenido 👋');}catch(err){presentAuthError('authHintLogin',err);}finally{setBusy(btn,false,'',orig);}}
function logout(){try{auth.signOut();}catch{}}

/* ===== UI ===== */
document.addEventListener('click',(e)=>{
  const t=e.target;
  if(t.closest('.tab')) showTab(t.closest('.tab').dataset.tab);
  if(t.id==='logoutBtn') logout();
  if(t.id==='crearEventoBtn') crearEvento();
  if(t.id==='registrarInvitadoBtn') registrarInvitado();
  if(t.id==='genFlyerBtn') genFlyerNow();
  if(t.id==='descargarQRBtn') descargarQR();
  if(t.id==='descargarFlyerBtn') descargarFlyer();
  if(t.id==='doneInviteBtn') { $('qrPreview').classList.add('hidden'); window.scrollTo({top:0,behavior:'smooth'}); }
  if(t.id==='buscarInvitadosBtn') filtrarInvitadosActual();
  if(t.id==='scanBtn') toggleScanner();
  if(t.id==='validarManualBtn') procesarManual();
  if(t.id==='fabScan'){showTab('escanear'); setTimeout(()=>toggleScanner(),200);}
  if(t.id==='modalCloseBtn'||t.id==='modalCheckin') hideModal();
  if(t.id==='torchBtn') toggleTorch();
  if(t.id==='clearLogoBtn' || t.id==='clearLogoBtnTop') clearLogo();
  if(t.id==='toggleLogoEditorBtn'){ $('logoEditor').classList.toggle('active'); }
  if(t.id==='logoResetBtn') resetLogoCfg();
  if(t.id==='logoToggleBtn') toggleLogoVisible();
  if(t.id==='toggleFontEditorBtn'){ $('fontEditor').classList.toggle('active'); }
  if(t.dataset?.act==='toggle') toggleFinalizado(t.dataset.id);
  if(t.dataset?.act==='ver') abrirBuscadorEvento(t.dataset.id);
  if(t.dataset?.act==='del') deleteEventAndGuests(t.dataset.id);
  if(t.id==='fontResetBtn') resetFontCfg();
});
document.addEventListener('input',(e)=>{
  if(e.target.id==='buscarInvitadosInput') filtrarInvitadosActual();
  if(e.target.id==='buscarCad') renderCaducadas();
  if(e.target.id==='buscarEventoSel') renderInvitadosDeEvento(e.target.value);
  if(e.target.id==='flyerThemeSel'){ state.ui.flyerTheme=e.target.value; repaintCurrentFlyer(); }
  if(e.target.id==='bgColorPick'){ state.ui.bgColor=e.target.value; repaintCurrentFlyer(); }
  if(e.target.id==='txColorPick'){ state.ui.txColor=e.target.value; repaintCurrentFlyer(); }
  if(e.target.id==='logoFile' || e.target.id==='logoFileTop'){ handleLogoUpload(e.target.files?.[0]); }
  if(['logoScale','logoX','logoY'].includes(e.target.id)) updateLogoCfgFromInputs();
  if(['fontHead','fontEvent','fontGuest','fontToken','fontNote'].includes(e.target.id)) updateFontCfgFromInputs();
  if(e.target.id==='invTipo') updateEgresadoSelectorVisibility();
  if(e.target.id==='invEvento') populateEgresadosForSelectedEvent();
  if(e.target.id==='manualCode'){ const v=(e.target.value||'').trim(); if(v.length>=6) { procesarManual(true); } }
});
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') hideModal(); });

function repaintCurrentFlyer(){ const gid=$('qrCanvas')?.dataset?.guestId; if(!gid) return; const g=state.guests.find(x=>x.id===gid); if(g) pintarFlyer(g); }
function syncUIAuth(){
  const logged = !!state.user;
  $('auth').classList.toggle('hidden', logged ? true : false && !mustHaveFirebase);
  $('app').classList.toggle('hidden', !logged);
  $('userBar').classList.toggle('hidden', !logged);
  $('userEmail').textContent = logged ? (state.user.email || '') : '';
  if (logged) {
    showTab(state.ui.currentTab || 'eventos');
    refrescarCombos();
    renderEventos();
    renderInvitadosRecientes();
    renderCaducadas();
    updateLogoPreview(); updateLogoPreviewTop();
    initLogoEditorInputs(); initFontEditorInputs();
  }
  $('modeBadge').textContent = 'cloud';
}

/* ===== Suscripciones ===== */
let unsubEvents=null,unsubGuests=null;
async function cloudSubscribe(){
  if(unsubEvents)unsubEvents(); if(unsubGuests)unsubGuests();
  unsubEvents=colEvents().onSnapshot(snap=>{
    state.events=snap.docs.map(d=>({id:d.id,...d.data()}));
    refrescarCombos(); renderEventos();
    if(state.ui.invitadosEventoActual){renderInvitadosDeEvento(state.ui.invitadosEventoActual);}
  },console.error);
  unsubGuests=colGuests().onSnapshot(snap=>{
    state.guests=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderInvitadosRecientes(); renderCaducadas(); renderEventos();
    if(state.ui.invitadosEventoActual){renderInvitadosDeEvento(state.ui.invitadosEventoActual);}
    populateEgresadosForSelectedEvent();
  },console.error);
}

/* ===== Tabs ===== */
function showTab(tab){
  state.ui.currentTab=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  $('vista-eventos').classList.toggle('hidden',tab!=='eventos');
  $('vista-invitados').classList.toggle('hidden',tab!=='invitados');
  $('vista-caducadas').classList.toggle('hidden',tab!=='caducadas');
  $('vista-escanear').classList.toggle('hidden',tab!=='escanear');
  // Mostrar el bloque de identidad SOLO en "invitados"
  const idTop = $('identidadTop');
  if (idTop) idTop.classList.toggle('hidden', tab!=='invitados');
}

/* ===== Eventos ===== */
async function crearEvento(){
  const nombre=($('evNombre').value||'').trim();
  const fecha=($('evFecha').value||'');
  if(!nombre) return toast('Poné un nombre para el evento');
  try{ await colEvents().add({nombre,fecha,finalizado:false}); toast('Evento creado'); $('evNombre').value=''; $('evFecha').value=''; }
  catch(e){ console.error(e); toast('No se pudo crear'); }
}
function renderEventos(){
  const cont=$('listaEventos'); if(!cont) return; cont.innerHTML='';
  if(state.events.length===0){cont.innerHTML='<div class="muted">No hay eventos todavía.</div>'; return;}
  state.events.slice().reverse().forEach(ev=>{
    const guestsEv = state.guests.filter(g=>g.eventId===ev.id);
    const egCount  = guestsEv.filter(g=>g.tipo==='egresado').length;
    const inCount  = guestsEv.filter(g=>g.tipo!=='egresado').length;
    const card=document.createElement('div'); card.className='event-card '+(ev.finalizado?'finalizado':'');
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800;font-size:1.1rem">${escapeHtml(ev.nombre)}</div>
          <div class="row" style="gap:8px;align-items:center;margin-top:4px">
            <span class="pill ${ev.finalizado?'':'ok'}">${ev.finalizado?'Finalizado':'Abierto'}</span>
            ${ev.fecha?`<span class="pill">📅 ${ev.fecha}</span>`:''}
            <span class="pill">🎓 ${egCount} egresado(s)</span>
            <span class="pill">👥 ${inCount} invitado(s)</span>
          </div>
        </div>
        <div class="row">
          <button class="btn ghost" data-id="${ev.id}" data-act="ver">Ver invitados</button>
          <button class="btn ${ev.finalizado?'ok':'gold'}" data-id="${ev.id}" data-act="toggle">${ev.finalizado?'Reabrir':'Finalizar'}</button>
          <button class="btn danger" data-id="${ev.id}" data-act="del" title="Eliminar evento e invitaciones">Eliminar</button>
        </div>
      </div>`;
    cont.appendChild(card);
  });
}
async function deleteEventAndGuests(eventId){
  const ev = state.events.find(e=>e.id===eventId);
  const nombre = ev?.nombre || 'este evento';
  const ok = confirm(`⚠️ Vas a eliminar "${nombre}". Se borrarán todas las invitaciones. ¿Confirmar?`);
  if(!ok) return;
  try{
    const snap = await colGuests().where('eventId','==',eventId).get();
    const guests = snap.docs.map(d=>({id:d.id}));
    for(let i=0;i<guests.length;i+=400){
      const batch = db.batch();
      guests.slice(i,i+400).forEach(g=>{batch.delete(colGuests().doc(g.id)); try{batch.delete(colPublic().doc(`${state.uid}_${g.id}`));}catch(_){}})
      await batch.commit();
    }
    await colEvents().doc(eventId).delete();
    toast('Evento e invitaciones eliminados ✔️');
    if(state.ui.invitadosEventoActual===eventId){
      state.ui.invitadosEventoActual=null;
      $('zonaInvitadosEvento').innerHTML='<div class="muted">Elegí un evento para ver sus invitados.</div>';
      $('buscarEventoSel').value='';
    }
  }catch(e){ console.error(e); toast('No se pudo eliminar'); }
}
async function toggleFinalizado(id){
  const ev=state.events.find(e=>e.id===id); if(!ev) return;
  try{ await colEvents().doc(id).update({finalizado:!ev.finalizado}); toast(!ev.finalizado?'Evento finalizado':'Evento reabierto'); }
  catch(e){ console.error(e); toast('Error al actualizar'); }
}
function abrirBuscadorEvento(eventId){ const sel=$('buscarEventoSel'); sel.value=eventId; renderInvitadosDeEvento(eventId); showTab('eventos'); }
function refrescarCombos(){
  const opts=state.events.map(e=>`<option value="${e.id}">${escapeHtml(e.nombre)}</option>`).join('');
  $('invEvento').innerHTML = `<option value="">Elegí un evento…</option>${opts}`;
  $('buscarEventoSel').innerHTML = `<option value="">Seleccioná…</option>${opts}`;
  $('scanEvento').innerHTML = `<option value="">(Cualquiera)</option>${opts}`;
  populateEgresadosForSelectedEvent();
}

/* ===== Invitados + QR ===== */
function updateEgresadoSelectorVisibility(){
  const tipo = $('invTipo').value;
  $('wrapInvEgresado').style.display = (tipo === 'invitado') ? 'block' : 'none';
}
function populateEgresadosForSelectedEvent(){
  const eventId = $('invEvento').value;
  const sel = $('invEgresadoSel');
  if(!sel) return;
  if(!eventId){ sel.innerHTML = '<option value="">Elegí egresado…</option>'; updateEgresadoSelectorVisibility(); return; }
  const egresados = state.guests.filter(g => g.eventId===eventId && g.tipo==='egresado').sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));
  let html = '<option value="">Elegí egresado…</option>';
  egresados.forEach(e => { html += `<option value="${e.id}">${escapeHtml(e.nombre)}</option>`; });
  sel.innerHTML = html;
  updateEgresadoSelectorVisibility();
}
async function registrarInvitado(){
  const nombre=($('invNombre').value||'').trim();
  const eventId=$('invEvento').value;
  const tipo = ($('invTipo').value||'egresado');
  const parentGradId = ($('invEgresadoSel')?.value||'');
  if(!nombre) return toast('Escribí el nombre');
  if(!eventId) return toast('Elegí el evento');
  if(tipo==='invitado'){
    if(!parentGradId) return toast('Elegí el egresado a asignar');
    const egExists = state.guests.some(g=>g.id===parentGradId && g.tipo==='egresado');
    if(!egExists) return toast('Egresado inválido para este evento');
  }
  let token; do{ token=newToken(); } while(state.guests.some(g=>g.token===token));
  const guest={ nombre,eventId,token,used:false,usedAt:null, tipo, parentGradId: (tipo==='invitado'? parentGradId : null) };
  try{
    const docRef=await colGuests().add(guest);
    const gid=docRef.id; state.ui.lastGuestId=gid; $('invNombre').value='';
    mostrarInvitacion({id:gid,...guest}); toast(`${tipo==='egresado'?'Egresado':'Invitado'} creado ✔️`);
    (async()=>{ try{
      const ev=state.events.find(e=>e.id===eventId);
      const tokenHash=await sha256hex(token);
      await colPublic().doc(`${state.uid}_${gid}`).set({ uid:state.uid, guestId:gid, nombre, eventName:ev?ev.nombre:'', tokenHash});
    }catch(e){ console.warn('No se pudo escribir public_guests',e); }})();
  }catch(e){ console.error(e); toast('No se pudo crear'); }
}
function buildShareURL(g){
  const base = (location.origin && location.origin!=='null') ? (location.origin+location.pathname) : (location.href.split('#')[0].split('?')[0]);
  return `${base}?u=${encodeURIComponent(state.uid)}&g=${encodeURIComponent(g.id)}&t=${encodeURIComponent(g.token)}`;
}
async function makeLocalQRCanvas(text, size=260){
  try{ const ok=await(window.qrLibReady||Promise.resolve(false)); if(ok && window.QRCode?.toCanvas){ const c=document.createElement('canvas'); c.width=c.height=size; await new Promise((res,rej)=> QRCode.toCanvas(c,String(text),{width:size,errorCorrectionLevel:'M',margin:2},(err)=>err?rej(err):res())); return c; } }catch(_){}
  return null;
}
async function externalQRCanvas(text,size=260){
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=rej; i.src=`https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&qzone=2&data=${encodeURIComponent(String(text))}`; });
  const c=document.createElement('canvas'); c.width=c.height=size; c.getContext('2d').drawImage(img,0,0,size,size); return c;
}
function mostrarInvitacion(guest){
  const ev=state.events.find(e=>e.id===guest.eventId);
  const wrap=$('qrCanvas'); const url=buildShareURL(guest);
  wrap.innerHTML=''; wrap.dataset.guestId=guest.id;
  (async()=>{ let c=await makeLocalQRCanvas(url,260); if(!c){ try{c=await externalQRCanvas(url,260);}catch(_){}} if(c) wrap.appendChild(c); })();
  $('qrNombre').textContent=guest.nombre;
  $('qrToken').textContent=guest.token;
  $('qrEvento').textContent=ev?ev.nombre:'—';
  $('qrPreview').classList.remove('hidden');
  pintarFlyer(guest);
}
function genFlyerNow(){
  const gid=$('qrCanvas')?.dataset?.guestId; if(!gid) return toast('Primero crea o selecciona un invitado');
  const g=state.guests.find(x=>x.id===gid); if(!g) return;
  pintarFlyer(g).then(()=>showModal());
}

/* ===== Logo / Fuentes ===== */
function updateLogoPreview(){ const prev=$('logoPreview'); if(prev){ if(state.ui.logoDataUrl){ prev.src=state.ui.logoDataUrl; prev.classList.remove('hidden'); } else { prev.src=''; prev.classList.add('hidden'); } } }
function updateLogoPreviewTop(){ const prev=$('logoPreviewTop'); if(prev){ if(state.ui.logoDataUrl){ prev.src=state.ui.logoDataUrl; prev.classList.remove('hidden'); } else { prev.src=''; prev.classList.add('hidden'); } } }
function handleLogoUpload(file){
  if(!file) return; const reader=new FileReader();
  reader.onload = ()=>{ state.ui.logoDataUrl = reader.result; localStorage.setItem('fq_logo', state.ui.logoDataUrl); updateLogoPreview(); updateLogoPreviewTop(); repaintCurrentFlyer(); toast('Logo actualizado ✔️'); };
  reader.readAsDataURL(file);
}
function clearLogo(){ state.ui.logoDataUrl=null; localStorage.removeItem('fq_logo'); repaintCurrentFlyer(); updateLogoPreview(); updateLogoPreviewTop(); toast('Logo quitado'); }
function initLogoEditorInputs(){ $('logoScale').value = state.ui.logo.scale; $('logoX').value = state.ui.logo.x; $('logoY').value = state.ui.logo.y; }
function updateLogoCfgFromInputs(){ state.ui.logo.scale=parseInt($('logoScale').value||160,10); state.ui.logo.x=parseInt($('logoX').value||60,10); state.ui.logo.y=parseInt($('logoY').value||560,10); localStorage.setItem('fq_logo_cfg', JSON.stringify(state.ui.logo)); repaintCurrentFlyer(); }
function resetLogoCfg(){ state.ui.logo = {x:60,y:560,scale:160,visible:true}; localStorage.setItem('fq_logo_cfg', JSON.stringify(state.ui.logo)); initLogoEditorInputs(); repaintCurrentFlyer(); }
function toggleLogoVisible(){ state.ui.logo.visible = !state.ui.logo.visible; localStorage.setItem('fq_logo_cfg', JSON.stringify(state.ui.logo)); repaintCurrentFlyer(); }

/* ===== Editor de fuentes ===== */
function initFontEditorInputs(){ $('fontHead').value = state.ui.fonts.head; $('fontEvent').value = state.ui.fonts.event; $('fontGuest').value = state.ui.fonts.guest; $('fontToken').value = state.ui.fonts.token; $('fontNote').value = state.ui.fonts.note; initFontValueLabels(); }
function updateFontCfgFromInputs(){ state.ui.fonts.head=parseInt($('fontHead').value||46,10); state.ui.fonts.event=parseInt($('fontEvent').value||72,10); state.ui.fonts.guest=parseInt($('fontGuest').value||40,10); state.ui.fonts.token=parseInt($('fontToken').value||34,10); state.ui.fonts.note=parseInt($('fontNote').value||26,10); localStorage.setItem('fq_font_cfg', JSON.stringify(state.ui.fonts)); initFontValueLabels(); repaintCurrentFlyer(); }
function initFontValueLabels(){ $('fontHeadVal').textContent=state.ui.fonts.head+' px'; $('fontEventVal').textContent=state.ui.fonts.event+' px'; $('fontGuestVal').textContent=state.ui.fonts.guest+' px'; $('fontTokenVal').textContent=state.ui.fonts.token+' px'; $('fontNoteVal').textContent=state.ui.fonts.note+' px'; }
function resetFontCfg(){ state.ui.fonts = { head:46, event:72, guest:40, token:34, note:26 }; localStorage.setItem('fq_font_cfg', JSON.stringify(state.ui.fonts)); initFontEditorInputs(); repaintCurrentFlyer(); }

/* ===== Flyer ===== */
async function pintarFlyer(guest){
  const ev=state.events.find(e=>e.id===guest.eventId);
  const theme = state.ui.flyerTheme || 'oro';
  const bgPick = state.ui.bgColor, txPick = state.ui.txColor;
  const F = state.ui.fonts;
  const c=document.createElement('canvas'); c.width=1200; c.height=675;
  const ctx=c.getContext('2d');

  if(theme==='oro'){ const g=ctx.createLinearGradient(0,0,0,c.height); g.addColorStop(0,'#fff7d1'); g.addColorStop(.55,'#f5d777'); g.addColorStop(1,'#d4af37'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='rgba(0,0,0,.08)'; for(let i=0;i<18;i++){ctx.fillRect(70*i,0,1,c.height);} }
  else if(theme==='plata'){ const g=ctx.createLinearGradient(0,0,c.width,0); g.addColorStop(0,'#f5f7fa'); g.addColorStop(1,'#cfd8dc'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='rgba(0,0,0,.06)'; for(let i=0;i<14;i++){ctx.fillRect(0,48*i,c.width,1);} }
  else if(theme==='noche'){ const g=ctx.createLinearGradient(0,0,0,c.height); g.addColorStop(0,'#0b1020'); g.addColorStop(1,'#1f2937'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='rgba(255,255,255,.06)'; for(let i=0;i<14;i++){ctx.fillRect(0,48*i,c.width,1);} }
  else { ctx.fillStyle = bgPick || '#ffffff'; ctx.fillRect(0,0,c.width,c.height); }

  ctx.fillStyle = (theme==='noche') ? '#f3f4f6' : (txPick || '#1f2937');

  ctx.font=`800 ${F.head}px "Poppins",sans-serif`; ctx.fillText('ESTÁS INVITADO/A A', 60, 80 + F.head);
  ctx.font=`900 ${F.event}px "Poppins",sans-serif`; wrapText(ctx, ev?ev.nombre:'', 60, 150 + F.head, 680, F.event);
  ctx.font=`700 ${F.guest}px "Poppins",sans-serif`; wrapText(ctx, `Nombre: ${guest.nombre}`, 60, 170 + F.head + F.event, 680, F.guest);
  ctx.font=`600 ${F.token}px "Poppins",sans-serif`; ctx.fillText(`Token: ${guest.token}`, 60, 200 + F.head + F.event + F.guest);

  /* Tipo de invitación (Egresado / Invitado) */
  ctx.font=`600 ${Math.max(22, Math.min(48, F.token-4))}px "Poppins",sans-serif`;
  ctx.fillText(`Tipo: ${guest.tipo==='egresado'?'Egresado':'Invitado'}`, 60, 230 + F.head + F.event + F.guest);

  ctx.font=`500 ${F.note}px "Poppins",sans-serif`; ctx.fillText('Presentá este flyer al ingresar. El QR o el token son de uso único.', 60, 260 + F.head + F.event + F.guest);

  const url=buildShareURL(guest); let qrCan = await makeLocalQRCanvas(url, 260); if(!qrCan){ try{ qrCan = await externalQRCanvas(url, 260); }catch(_){ } }
  const qrX = c.width - 60 - 260, qrY = 60;
  if(qrCan){ ctx.save(); ctx.shadowColor='rgba(0,0,0,.18)'; ctx.shadowBlur=12; ctx.fillStyle='#fff'; roundRect(ctx, qrX-10, qrY-10, 280, 280, 16); ctx.fill(); ctx.restore(); ctx.drawImage(qrCan, qrX, qrY, 260, 260); }
  if(state.ui.logoDataUrl && state.ui.logo.visible){ try{ const img = await loadImage(state.ui.logoDataUrl); const baseW=360; const scale=(state.ui.logo.scale||160)/100; const w=Math.max(40,Math.round(baseW*scale)); const ratio = (img.naturalWidth||img.width)/(img.naturalHeight||img.height); const h=Math.round(w/ratio); const x=Math.min(Math.max(0,state.ui.logo.x||60),1200-w); const y=Math.min(Math.max(0,state.ui.logo.y||560),675-h); ctx.drawImage(img,x,y,w,h); }catch(e){ console.warn('Logo invalido',e); } }

  state.flyers.lastDataUrl=c.toDataURL('image/png'); $('checkinFlyerImg').src=state.flyers.lastDataUrl;
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight, lineGap=12){ const words=String(text||'').split(' '); let line='', yy=y; for(let n=0;n<words.length;n++){ const test=line+words[n]+' '; if(ctx.measureText(test).width>maxWidth && n>0){ ctx.fillText(line,x,yy); line=words[n]+' '; yy+=lineHeight+lineGap; } else line=test; } ctx.fillText(line,x,yy); }
function roundRect(ctx, x, y, w, h, r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }

/* Descargar / Imprimir */
function descargarQR(){
  const wrap=$('qrCanvas'); if(!wrap) return; const node=wrap.querySelector('canvas,img'); if(!node) return;
  const g=state.guests.find(x=>x.id===wrap.dataset.guestId); const name=g?g.nombre.replace(/\s+/g,'_'):'invitado';
  if(node.tagName.toLowerCase()==='canvas'){ const a=document.createElement('a'); a.download=`QR_${name}.png`; a.href=node.toDataURL('image/png'); a.click(); return; }
  if(node.tagName.toLowerCase()==='img'){ const c=document.createElement('canvas'); const w=node.naturalWidth||260,h=node.naturalHeight||260; c.width=w;c.height=h; const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ c.getContext('2d').drawImage(img,0,0,w,h); const a=document.createElement('a'); a.download=`QR_${name}.png`; a.href=c.toDataURL('image/png'); a.click(); }; img.src=node.src; }
}
function descargarFlyer(){ const url=state.flyers.lastDataUrl; if(!url) return toast('Primero generá un flyer'); const gid=$('qrCanvas')?.dataset?.guestId; const g=state.guests.find(x=>x.id===gid); const name=g?g.nombre.replace(/\s+/g,'_'):'invitado'; const a=document.createElement('a'); a.download=`FLYER_${name}.png`; a.href=url; a.click(); }
function verQR(guestId){ const g=state.guests.find(x=>x.id===guestId); if(!g) return; mostrarInvitacion(g); showTab('invitados'); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); }
function regenerarQR(guestId){ verQR(guestId); toast('QR regenerado'); }

/* Invitados recientes */
function renderInvitadosRecientes(){
  const cont=$('listaInvitadosRecientes'); if(!cont) return; const ult=state.guests.slice(-12).reverse();
  if(ult.length===0){cont.innerHTML='<div class="muted">Todavía no hay invitados.</div>'; return;}
  cont.innerHTML='<div class="list"></div>'; const list=cont.querySelector('.list');
  ult.forEach(g=>{
    const ev=state.events.find(e=>e.id===g.eventId);
    const tipoBadge = `<span class="pill">${g.tipo==='egresado'?'Egresado':'Invitado'}</span>`;
    const div=document.createElement('div'); div.className='row'; div.style.justifyContent='space-between'; div.style.alignItems='center';
    div.innerHTML = `
      <div>
        <div style="font-weight:700">${escapeHtml(g.nombre)} ${tipoBadge}</div>
        <div class="muted">Evento: ${ev?escapeHtml(ev.nombre):'—'} · Token: ${g.token}</div>
      </div>
      <div class="actions">
        <button class="btn ghost" data-verqr="${g.id}">Ver QR</button>
        <button class="btn ok" data-regen="${g.id}">Re-generar</button>
        <button class="btn danger" onclick="deleteGuestCascade('${g.id}')">Eliminar</button>
        ${g.used?'<span class="pill">Caducada</span>':'<span class="pill ok">Disponible</span>'}
      </div>`;
    list.appendChild(div);
  });
  list.querySelectorAll('button[data-verqr]').forEach(b=> b.onclick=()=> verQR(b.dataset.verqr));
  list.querySelectorAll('button[data-regen]').forEach(b=> b.onclick=()=> regenerarQR(b.dataset.regen));
}

/* Caducadas */
function renderCaducadas(){
  const box=$('listaCaducadas'); if(!box) return;
  const term=($('buscarCad').value||'').toLowerCase();
  const usadas=state.guests.filter(g=>g.used).map(g=>({g,ev:state.events.find(e=>e.id===g.eventId)}))
    .filter(x=>(x.g.nombre+' '+(x.ev?x.ev.nombre:'')).toLowerCase().includes(term)).reverse();
  if(usadas.length===0){ box.innerHTML='<div class="muted">Sin registros aún.</div>'; return; }
  let html='<div style="overflow:auto"><table class="table"><thead><tr><th>Nombre</th><th>Evento</th><th>Fecha de uso</th><th>Token</th><th></th></tr></thead><tbody>';
  usadas.forEach(({g,ev})=>{
    const usado=g.usedAt?new Date(g.usedAt).toLocaleString():'—';
    html+=`<tr><td>${escapeHtml(g.nombre)}</td><td>${ev?escapeHtml(ev.nombre):'—'}</td><td>${usado}</td><td class="muted">${g.token}</td><td><button class="btn ok" data-reactivar="${g.id}">Reactivar</button></td></tr>`;
  });
  html+='</tbody></table></div>'; box.innerHTML=html;
  box.querySelectorAll('button[data-reactivar]').forEach(b=> b.onclick=()=> reactivarInvitacion(b.dataset.reactivar));
}
async function reactivarInvitacion(guestId){ try{ await colGuests().doc(guestId).update({used:false,usedAt:null}); toast('Invitación reactivada'); }catch(e){ console.error(e); toast('Error al reactivar'); } }

/* Eliminar invitado/egresado (cascada) */
async function deleteGuestCascade(guestId){
  const gSnap = await colGuests().doc(guestId).get();
  if(!gSnap.exists) { toast('Invitado no encontrado'); return; }
  const g = {id:guestId, ...gSnap.data()};
  const esEgresado = g.tipo==='egresado';
  const msg = esEgresado? 'Eliminar EGRESADO y TODOS sus invitados. ¿Confirmar?' : 'Eliminar este invitado. ¿Confirmar?';
  if(!confirm(msg)) return;
  try{
    if(esEgresado){
      const hijosSnap = await colGuests().where('parentGradId','==',guestId).get();
      const hijos = hijosSnap.docs.map(d=>({id:d.id}));
      for(let i=0;i<hijos.length;i+=400){
        const batch = db.batch();
        hijos.slice(i,i+400).forEach(h=>{ batch.delete(colGuests().doc(h.id)); try{ batch.delete(colPublic().doc(`${state.uid}_${h.id}`)); }catch(_){ } });
        await batch.commit();
      }
    }
    await colGuests().doc(guestId).delete();
    try{ await colPublic().doc(`${state.uid}_${guestId}`).delete(); }catch(_){}
    toast(esEgresado?'Egresado e invitados eliminados ✔️':'Invitado eliminado ✔️');
  }catch(e){ console.error(e); toast('No se pudo eliminar'); }
}

/* ===== Eventos → listar sólo EGRESADOS; “Ver invitados” + “Ver QR” ===== */
function renderInvitadosDeEvento(eventId){
  state.ui.invitadosEventoActual=eventId;
  const zona=$('zonaInvitadosEvento');
  const ev=state.events.find(e=>e.id===eventId);
  if(!ev){ zona.innerHTML='<div class="muted">Elegí un evento para ver sus invitados.</div>'; return; }

  const q=($('buscarInvitadosInput').value||'').trim().toLowerCase();
  const egresados = state.guests
    .filter(g=>g.eventId===eventId && g.tipo==='egresado' && g.nombre.toLowerCase().includes(q))
    .sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));

  zona.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="muted">Egresados en "${escapeHtml(ev.nombre)}": ${egresados.length}</div>
      <div class="row"><button class="btn ghost" id="scanHereBtn">Escanear aquí</button></div>
    </div>
    <div class="list" id="eg_list_evt"></div>`;

  const list = zona.querySelector('#eg_list_evt');

  egresados.forEach(egr=>{
    const hijos = state.guests.filter(x=>x.parentGradId===egr.id);
    const card = document.createElement('div'); card.className='event-card';
    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">${escapeHtml(egr.nombre)} <span class="pill">Egresado</span></div>
          <div class="mini muted">Acompañantes: ${hijos.length}</div>
        </div>
        <div class="row">
          <button class="btn ghost" data-eg-ver="${egr.id}">Ver invitados (${hijos.length})</button>
          <button class="btn ghost" data-eg-qr="${egr.id}">Ver QR</button>
          <button class="btn danger" data-eg-del="${egr.id}">Eliminar egresado</button>
        </div>
      </div>
      <div id="eg_${egr.id}_evtbox" class="hidden" style="margin-top:10px"></div>`;
    list.appendChild(card);
  });

  zona.querySelector('#scanHereBtn').onclick=()=>{ $('scanEvento').value=ev.id; showTab('escanear'); setTimeout(()=>toggleScanner(),150); };
  list.querySelectorAll('[data-eg-del]').forEach(b=> b.onclick=()=> deleteGuestCascade(b.dataset.egDel));
  list.querySelectorAll('[data-eg-qr]').forEach(b=> b.onclick=()=> verQR(b.dataset.egQr));
  list.querySelectorAll('[data-eg-ver]').forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.egVer;
      const box = $('eg_'+id+'_evtbox');
      if(!box) return;
      const hijos = state.guests.filter(x=>x.parentGradId===id).sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));
      if(box.classList.contains('hidden')){
        if(hijos.length===0){ box.innerHTML='<div class="muted">Sin invitados asignados.</div>'; }
        else{
          let html = `<div style="overflow:auto"><table class="table">
            <thead><tr><th>Invitado</th><th>Token</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>`;
          hijos.forEach(h=>{
            html += `<tr>
              <td>${escapeHtml(h.nombre)}</td>
              <td class="muted">${h.token}</td>
              <td>${h.used?'<span class="pill">Caducada</span>':'<span class="pill ok">Disponible</span>'}</td>
              <td class="actions">
                <button class="btn ghost" onclick="verQR('${h.id}')">Ver QR</button>
                <button class="btn ok" onclick="regenerarQR('${h.id}')">Re-generar</button>
                <button class="btn danger" onclick="deleteGuestCascade('${h.id}')">Eliminar</button>
              </td>
            </tr>`;
          });
          html+='</tbody></table></div>';
          box.innerHTML = html;
        }
        box.classList.remove('hidden');
      }else{ box.classList.add('hidden'); box.innerHTML=''; }
    };
  });
}
function filtrarInvitadosActual(){ if(state.ui.invitadosEventoActual){ renderInvitadosDeEvento(state.ui.invitadosEventoActual); } }

/* ===== Escaneo ===== */
let stream=null, barcodeReader=null, rafId=null, detector=null, torchOn=false, track=null;
let scanningBusy=false, lastDecoded='', lastTime=0;
async function toggleScanner(){
  const btn=$('scanBtn'); const hint=$('cameraHint');
  if(stream){ await stopScanner(); btn.textContent='Iniciar cámara'; return; }
  try{
    const sel=$('resSel').value; let width={ideal:1280}, height={ideal:720};
    if(sel==='fhd'){ width={ideal:1920}; height={ideal:1080}; } if(sel==='auto'){ width={ideal:1280}; height={ideal:720}; }
    stream=await navigator.mediaDevices.getUserMedia({ video:{ width, height, facingMode:{ideal:'environment'} }, audio:false });
    const video=$('video'); video.setAttribute('playsinline','true'); video.srcObject=stream; await video.play();
    $('scanResultado').textContent='Cámara lista. Escaneando…'; hint.textContent=''; track = stream.getVideoTracks()[0];

    if('BarcodeDetector' in window){
      detector = new window.BarcodeDetector({formats:['qr_code']});
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const loop=async()=>{ if(!stream) return; try{ const now=performance.now(); if(now-lastTime>60){ canvas.width=video.videoWidth||640; canvas.height=video.videoHeight||480; ctx.drawImage(video,0,0,canvas.width,canvas.height); const codes=await detector.detect(canvas); if(codes && codes.length){ await onDecoded(codes[0].rawValue); } lastTime = now; } }catch(_){}
        rafId=requestAnimationFrame(loop); }; loop();
    }

    barcodeReader = new ZXing.BrowserMultiFormatReader();
    try{ barcodeReader.decodeFromVideoElementContinuously(video, async (result, err)=>{ if(result && result.getText){ await onDecoded(result.getText()); } }); }catch(_){}
    btn.textContent='Detener cámara';
  }catch(err){ console.error(err); hint.textContent='No se pudo abrir la cámara.'; toast('No se pudo abrir la cámara'); }
}
async function onDecoded(text){ if(scanningBusy) return; if(!text) return; if(text===lastDecoded) return; scanningBusy=true; lastDecoded=text; try{ await handleScan(text); } finally{ setTimeout(()=>{ scanningBusy=false; }, 500); } }
async function toggleTorch(){ try{ if(!track) return toast('Torch no disponible'); const cap=track.getCapabilities?.(); if(!cap||!cap.torch) return toast('Este dispositivo no soporta linterna'); torchOn=!torchOn; await track.applyConstraints({advanced:[{torch: torchOn}]}); toast(torchOn?'Linterna encendida':'Linterna apagada'); }catch(e){ console.warn(e); toast('No se pudo cambiar la linterna'); } }
async function stopScanner(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } if(barcodeReader){ try{ barcodeReader.reset(); }catch{} barcodeReader=null; } if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } const video=$('video'); try{ video.pause(); }catch{} video.srcObject=null; $('scanResultado').textContent='Cámara detenida'; scanningBusy=false; lastDecoded=''; }
function setScanMsg(msg){ $('scanResultado').textContent=msg; }
function procesarManual(fromTyping=false){ const v=($('manualCode').value||'').trim(); if(!v) return; if(fromTyping && v.length<6 && !v.includes('?u=')) return; handleScan(v); }
async function handleScan(raw){
  try{ const url=new URL(raw); const u=url.searchParams.get('u'), g=url.searchParams.get('g'), t=url.searchParams.get('t'); if(u&&g&&t){ await checkinFromURL(u,g,t); return; } }catch(_){}
  const code=(raw||'').trim(); const g=state.guests.find(x=>x.token===code);
  if(!g){ setScanMsg('❌ QR/Token no válido'); return; }
  const filtroEv=$('scanEvento').value; if(filtroEv && g.eventId!==filtroEv){ setScanMsg('⛔ Pertenece a otro evento'); return; }
  if(g.used){ setScanMsg(`⚠️ Ya usado por ${g.nombre}`); return; }
  await marcarUsadoYMostrar(g);
}
async function checkinFromURL(u,gid,token){
  if(!state.uid){ setScanMsg('Iniciá sesión para escanear'); return; }
  if(state.uid!==u){ setScanMsg('⛔ Este QR pertenece a otra cuenta'); return; }
  try{
    const tokenHash=await sha256hex(decodeURIComponent(token||'')); 
    const doc=await colPublic().doc(`${u}_${gid}`).get();
    if(!doc.exists){ setScanMsg('❌ Enlace inválido'); return; }
    const data=doc.data(); if(data.tokenHash!==tokenHash){ setScanMsg('⛔ Token incorrecto'); return; }
    const gSnap=await colGuests().doc(gid).get(); if(!gSnap.exists){ setScanMsg('❌ Invitación no encontrada'); return; }
    const guest={id:gid,...gSnap.data()};
    const filtroEv=$('scanEvento').value; if(filtroEv && guest.eventId!==filtroEv){ setScanMsg('⛔ Pertenece a otro evento'); return; }
    if(guest.used){ setScanMsg(`⚠️ Ya usado por ${guest.nombre}`); return; }
    await marcarUsadoYMostrar(guest);
  }catch(e){ console.error(e); setScanMsg('⚠️ Error al validar'); }
}
async function marcarUsadoYMostrar(guest){
  const ts=Date.now();
  try{ await colGuests().doc(guest.id).update({used:true,usedAt:ts}); }
  catch(e){ console.error(e); toast('No se pudo marcar el ingreso'); return; }
  await pintarFlyer(guest); showModal();
  const ev=state.events.find(e=>e.id===guest.eventId);
  setScanMsg(`✅ Invitado: ${guest.nombre} — Evento: ${ev?ev.nombre:''}`);
  renderCaducadas(); filtrarInvitadosActual(); renderInvitadosRecientes(); renderEventos();
}
function showModal(){ $('modalCheckin').style.display='flex'; }
function hideModal(){ $('modalCheckin').style.display='none'; }

/* ===== Boot ===== */
window.addEventListener('load',async()=>{ await initCloud(); if(!mustHaveFirebase) return; initLogoEditorInputs(); initFontEditorInputs(); updateEgresadoSelectorVisibility(); });
</script>
</body>
</html>
